env:
  CARGO_INCREMENTAL: '0'
  CARGO_NET_RETRY: '10'
  RUSTUP_MAX_RETRIES: '10'
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Fetch tags
      run: git fetch --tags --no-recurse-submodules
    - uses: dtolnay/rust-toolchain@nightly
      with:
        targets: x86_64-unknown-linux-gnu
    - name: Install mold
      uses: rui314/setup-mold@v1
    - name: Remove .cargo/config.toml
      run: rm -f .cargo/config.toml .cargo/config
    - name: Build release binary
      run: cargo build --release --target x86_64-unknown-linux-gnu
    - name: Package binary
      run: 'cd target/x86_64-unknown-linux-gnu/release

        PNAME="${GITHUB_REPOSITORY##*/}"

        tar -czvf ../../../${PNAME}-x86_64-unknown-linux-gnu.tar.gz $PNAME

        '
    - id: version
      name: Resolve version tag
      run: "if [[ \"${{ github.ref_type }}\" == \"tag\" ]]; then\n  echo \"tag=${{\
        \ github.ref_name }}\" >> \"$GITHUB_OUTPUT\"\nelse\n  LATEST=$(git tag -l\
        \ 'v[0-9]*' --sort=-v:refname | head -1)\n  if [[ -n \"$LATEST\" ]]; then\n\
        \    echo \"tag=$LATEST\" >> \"$GITHUB_OUTPUT\"\n  else\n    echo \"::notice::No\
        \ existing v* tags found, skipping versioned release\"\n    echo \"tag=\"\
        \ >> \"$GITHUB_OUTPUT\"\n  fi\nfi\n"
      shell: bash
    - env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      name: Release (latest)
      uses: softprops/action-gh-release@v2
      with:
        files: ${{ github.event.repository.name }}-x86_64-unknown-linux-gnu.tar.gz
        make_latest: false
        name: Latest linux-x86_64
        prerelease: true
        tag_name: latest-linux-x86_64
    - env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      if: steps.version.outputs.tag != ''
      name: Release (versioned)
      uses: softprops/action-gh-release@v2
      with:
        files: ${{ github.event.repository.name }}-x86_64-unknown-linux-gnu.tar.gz
        tag_name: ${{ steps.version.outputs.tag }}
name: Release linux-x86_64
'on':
  push:
    tags:
    - v[0-9]+.*
  workflow_dispatch: {}
permissions:
  contents: write
